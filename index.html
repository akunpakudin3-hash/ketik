<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ujian Mengetik AI - SMP Kelas 8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Plus+Jakarta+Sans:wght@400;600;800&family=Russo+One&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SheetJS (Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js for Live Graph -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' },
                        surface: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 900: '#0f172a' }
                    },
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace'],
                        display: ['"Russo One"', 'sans-serif'],
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'fadeIn': 'fadeIn 0.5s ease-out forwards',
                        'slideUp': 'slideUp 0.5s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'shine': 'shine 1s linear infinite',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        fadeIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        shine: {
                            '0%': { backgroundPosition: '200% center' },
                            '100%': { backgroundPosition: '-200% center' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f8fafc;
            background-image: 
                radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(37, 99, 235, 0.1) 0px, transparent 50%);
            color: #1e293b;
            height: 100vh;
            overflow: hidden;
        }
        .clean-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.1);
        }
        .clean-input {
            background: #ffffff; border: 1px solid #e2e8f0; color: #1e293b; transition: all 0.2s ease;
        }
        .clean-input:focus {
            border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); outline: none;
        }
        #typing-area { line-height: 1.8; font-size: 1.6rem; user-select: none; }
        .letter { position: relative; transition: color 0.1s ease; }
        .letter.correct { color: #334155; }
        .letter.incorrect { color: #ef4444; background-color: #fef2f2; text-decoration: underline; text-decoration-color: #ef4444; border-radius: 2px; }
        .letter.pending { color: #cbd5e1; }
        .letter.active::before {
            content: ''; position: absolute; left: -1px; top: 15%; height: 70%; width: 2px;
            background-color: #2563eb; border-radius: 2px; animation: blink 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        
        /* Keyboard & Scrollbar */
        .keyboard-base {
            background: #e2e8f0; padding: 12px; border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
            border: 1px solid #cbd5e1; display: inline-block;
        }
        .key-row { display: flex; justify-content: center; gap: 6px; margin-bottom: 6px; }
        .key {
            height: 44px; width: 44px; background: #ffffff; border-radius: 8px; color: #475569;
            font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600;
            display: flex; align-items: center; justify-content: center;
            border-bottom: 2px solid #cbd5e1; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .key.w-auto { width: auto; padding: 0 16px; }
        .key.w-space { width: 280px; }
        .key.w-tab { width: 70px; }
        .key.w-caps { width: 80px; }
        .key.w-enter { width: 90px; }
        .key.w-shift { width: 105px; }
        .key.w-backspace { width: 70px; }
        .key.pressed {
            transform: translateY(2px); background-color: #3b82f6; color: #ffffff;
            border-bottom: 0px solid transparent; box-shadow: 0 0 10px rgba(59, 130, 246, 0.4);
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; border: 2px solid #f8fafc; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%); color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25); border: 1px solid rgba(255,255,255,0.2);
        }
        .btn-primary:hover { box-shadow: 0 6px 16px rgba(37, 99, 235, 0.35); transform: translateY(-1px); }
        .btn-primary:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #ffffff; border: 1px solid #e2e8f0; color: #475569; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-secondary:hover { background: #f8fafc; color: #1e293b; border-color: #cbd5e1; }
        .brand-text-gradient {
            background: linear-gradient(to right, #2563eb, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem;
        }
        /* Status Indicator Styles */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-online { background-color: #22c55e; box-shadow: 0 0 8px rgba(34, 197, 94, 0.5); }
        .status-offline { background-color: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.5); }
        .status-checking { background-color: #fbbf24; animation: pulse 1s infinite; }
        
        /* Loading Overlay */
        #loading-overlay {
            z-index: 100;
        }
        
        /* Toast Notification */
        #toast-notification {
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 100;
        }

        /* Live Board Styles */
        .gold-gradient { background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%); }
        .silver-gradient { background: linear-gradient(135deg, #E0E0E0 0%, #BDBDBD 100%); }
        .bronze-gradient { background: linear-gradient(135deg, #CD7F32 0%, #A0522D 100%); }
        
        .podium-card {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .podium-card:hover {
            transform: translateY(-10px) scale(1.02);
        }
    </style>
</head>
<body class="flex flex-col h-full selection:bg-brand-100 selection:text-brand-700">

    <!-- Header -->
    <header class="flex justify-between items-center px-8 py-5 clean-panel sticky top-0 z-40 border-b-0">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-brand-600 to-brand-500 flex items-center justify-center shadow-lg shadow-brand-500/20">
                <i class="fas fa-keyboard text-white text-lg"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold tracking-tight text-slate-800 font-sans">UJIAN MENGETIK <span class="brand-text-gradient">AI</span></h1>
                <div class="flex items-center gap-2">
                    <p class="text-xs text-slate-500 tracking-wide font-medium">SMP KELAS 8</p>
                    <span class="text-xs text-slate-300">â€¢</span>
                    <!-- Connection Status -->
                    <div id="db-status" class="flex items-center bg-white px-2 py-0.5 rounded-full border border-slate-200 shadow-sm">
                        <span id="db-dot" class="status-dot status-checking"></span>
                        <span id="db-text" class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">KONEKSI...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="live-stats" class="hidden flex gap-8 bg-white px-6 py-2 rounded-full border border-slate-200 shadow-sm">
            <div class="flex flex-col items-center">
                <span class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Waktu (Detik)</span>
                <span id="timer" class="text-xl font-mono text-brand-600 font-bold">0</span>
            </div>
            <div class="w-px h-8 bg-slate-100"></div>
            <div class="flex flex-col items-center">
                <span class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">WPM</span>
                <span id="wpm-live" class="text-xl font-mono text-slate-700 font-bold">0</span>
            </div>
            <div class="w-px h-8 bg-slate-100"></div>
            <div class="flex flex-col items-center">
                <span class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Akurasi</span>
                <span id="accuracy-live" class="text-xl font-mono text-slate-700 font-bold">100%</span>
            </div>
        </div>

        <button id="leaderboard-btn" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2 group">
            <span class="w-6 h-6 rounded-full bg-brand-50 flex items-center justify-center group-hover:bg-brand-100 transition">
                <i class="fas fa-trophy text-brand-500 text-xs"></i>
            </span>
            <span>Peringkat</span>
        </button>
    </header>

    <!-- Main -->
    <main class="flex-grow flex flex-col items-center justify-center relative w-full max-w-6xl mx-auto p-6">
        <div id="game-container" class="w-full relative flex-grow flex flex-col justify-center">
            <div id="focus-error" class="hidden absolute inset-0 z-20 flex items-center justify-center bg-white/50 backdrop-blur-sm rounded-xl cursor-pointer">
                <div class="bg-white px-6 py-3 rounded-full border border-brand-200 text-brand-600 font-bold shadow-lg shadow-brand-500/10 animate-bounce">
                    <i class="fas fa-mouse-pointer mr-2"></i> Klik untuk melanjutkan
                </div>
            </div>
            
            <div id="loading-overlay" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-white/80 backdrop-blur-sm rounded-xl z-50">
                <div class="w-12 h-12 border-4 border-brand-200 border-t-brand-600 rounded-full animate-spin mb-4"></div>
                <p class="text-brand-600 font-bold animate-pulse">Gemini AI sedang membuat soal...</p>
            </div>

            <div id="typing-area" class="font-mono text-justify break-words text-slate-300 bg-transparent py-8 px-4 min-h-[200px] outline-none max-w-4xl mx-auto w-full"></div>
            
            <!-- Quick Restart Button Hidden -->
            <div class="flex justify-center mt-4 opacity-50 hover:opacity-100 transition hidden">
                <button id="quick-restart" class="text-slate-400 hover:text-slate-700 transition p-3 rounded-full hover:bg-slate-200" title="Batal & Ulang">
                    <i class="fas fa-redo"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed top-24 right-6 transform translate-x-full opacity-0 pointer-events-none">
        <div class="bg-white border-l-4 border-green-500 shadow-2xl rounded-r-lg p-4 flex items-center gap-3 pr-8 ring-1 ring-slate-100">
            <div class="text-green-500"><i class="fas fa-check-circle text-xl"></i></div>
            <div>
                <h4 class="font-bold text-sm text-slate-800">Status Ujian</h4>
                <p id="toast-message" class="text-xs text-slate-500">Pesan notifikasi...</p>
            </div>
        </div>
    </div>

    <!-- Start Overlay (Floating Modal) -->
    <div id="start-overlay" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-slate-900/40 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-3xl border border-white/50 shadow-2xl w-full max-w-md relative overflow-hidden flex flex-col animate-float">
            <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-br from-brand-50 to-white z-0"></div>
            <div class="absolute top-4 right-4 z-10 w-20 h-20 bg-brand-100/50 rounded-full blur-2xl pointer-events-none"></div>

            <div class="text-center mb-6 relative z-10">
                <div class="w-16 h-16 bg-white rounded-2xl shadow-lg flex items-center justify-center mx-auto mb-4 border border-slate-100">
                    <i class="fas fa-user-circle text-3xl text-brand-500"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 font-sans">Identitas Siswa</h2>
                <p class="text-slate-500 text-sm">Lengkapi data untuk memulai ujian.</p>
                <!-- Show Client ID small -->
                <p class="text-[10px] text-slate-400 mt-2">Komputer ID: <span id="display-client-id" class="font-mono font-bold text-brand-600">...</span></p>
            </div>
            
            <div class="flex flex-col gap-4 relative z-10">
                <div id="limit-warning" class="hidden bg-red-50 border border-red-100 text-red-600 px-4 py-3 rounded-xl text-sm text-center flex items-center justify-center gap-2 shadow-sm">
                    <i class="fas fa-lock"></i> Kesempatan ujian telah habis.
                </div>
                <div class="space-y-1.5">
                    <label class="block text-xs text-slate-500 font-bold uppercase tracking-wider ml-1">Nama Lengkap</label>
                    <div class="relative">
                        <i class="fas fa-user absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                        <input type="text" id="input-nama" class="clean-input w-full rounded-xl pl-10 pr-4 py-3 text-sm font-medium" placeholder="Masukkan nama lengkap...">
                    </div>
                </div>
                <div class="flex gap-4">
                    <div class="flex-1 space-y-1.5">
                        <label class="block text-xs text-slate-500 font-bold uppercase tracking-wider ml-1">Kelas (8)</label>
                        <div class="relative">
                            <i class="fas fa-layer-group absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs z-10"></i>
                            <select id="input-kelas" class="clean-input w-full rounded-xl pl-10 pr-4 py-3 text-sm font-medium appearance-none cursor-pointer relative z-0">
                                <option value="" disabled selected>Pilih</option>
                                <option value="VIII-A">VIII-A</option>
                                <option value="VIII-B">VIII-B</option>
                                <option value="VIII-C">VIII-C</option>
                                <option value="VIII-D">VIII-D</option>
                                <option value="VIII-E">VIII-E</option>
                                <option value="VIII-F">VIII-F</option>
                                <option value="VIII-G">VIII-G</option>
                                <option value="VIII-H">VIII-H</option>
                            </select>
                        </div>
                    </div>
                    <div class="w-1/3 space-y-1.5">
                        <label class="block text-xs text-slate-500 font-bold uppercase tracking-wider ml-1">No. Absen</label>
                        <div class="relative">
                            <i class="fas fa-hashtag absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                            <input type="number" id="input-absen" class="clean-input w-full rounded-xl pl-9 pr-2 py-3 text-sm font-medium text-center" placeholder="00" min="1" max="40">
                        </div>
                    </div>
                </div>
                <div class="mt-2 pt-5 border-t border-slate-100 flex flex-col gap-3">
                    <div class="flex justify-between items-center bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <div class="flex flex-col">
                                <span class="text-[10px] uppercase text-slate-400 font-bold">Mode Waktu</span>
                                <span class="font-mono font-bold text-slate-800 text-sm"><i class="fas fa-stopwatch mr-1 text-brand-500"></i> Sampai Selesai</span>
                            </div>
                            <div class="flex flex-col text-right">
                                <span class="text-[10px] uppercase text-slate-400 font-bold">Kesempatan</span>
                                <span id="trials-display" class="font-mono font-bold text-brand-600 text-sm">2 / 2</span>
                            </div>
                    </div>
                    <button id="start-btn" class="btn-primary w-full py-4 rounded-xl font-bold text-sm tracking-wide uppercase transition transform hover:scale-[1.02] active:scale-[0.98] flex justify-center items-center gap-2 shadow-lg shadow-brand-500/20">
                        <span>Mulai Ujian</span> <i class="fas fa-arrow-right"></i>
                    </button>
                    <!-- Tombol Reset diganti menjadi Tombol Admin -->
                    <button id="start-admin-btn" class="text-[10px] text-slate-400 hover:text-brand-600 mt-2 transition text-center flex items-center justify-center gap-1 mx-auto">
                        <i class="fas fa-user-shield"></i> Login Admin (Guru)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Overlay -->
    <div id="result-overlay" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white/80 backdrop-blur-md hidden">
        <div class="text-center w-full max-w-lg bg-white p-8 rounded-3xl border border-slate-200 shadow-2xl animate-[fadeIn_0.5s_ease-out] relative">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-brand-400 to-brand-600"></div>
            <div class="w-16 h-16 rounded-full bg-green-50 flex items-center justify-center mx-auto mb-4 border border-green-100 shadow-sm">
                <i class="fas fa-check text-green-500 text-2xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-1 font-sans">Ujian Selesai</h2>
            <p class="text-slate-500 text-sm mb-6">Data nilai Anda telah berhasil direkam.</p>
            
            <!-- AI Feedback Section -->
            <div class="bg-brand-50 p-4 rounded-xl border border-brand-100 mb-6 text-left relative overflow-hidden">
                <div class="absolute top-0 right-0 p-2 opacity-10"><i class="fas fa-robot text-4xl text-brand-600"></i></div>
                <p class="text-[10px] text-brand-500 uppercase font-bold tracking-wider mb-1">Komentar Guru AI</p>
                <p id="ai-feedback" class="text-sm text-slate-700 italic leading-relaxed">"Sedang menganalisis performa Anda..."</p>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-4 rounded-xl border border-slate-100 flex flex-col items-center shadow-sm">
                    <span class="text-4xl font-mono font-bold text-brand-600 tracking-tighter" id="final-wpm">0</span>
                    <span class="text-[10px] text-slate-400 mt-1 uppercase tracking-widest font-bold">WPM (Speed)</span>
                </div>
                <div class="bg-white p-4 rounded-xl border border-slate-100 flex flex-col items-center shadow-sm">
                    <span class="text-4xl font-mono font-bold text-emerald-600 tracking-tighter" id="final-acc">0%</span>
                    <span class="text-[10px] text-slate-400 mt-1 uppercase tracking-widest font-bold">Akurasi</span>
                </div>
            </div>
            
            <div id="save-msg" class="h-5 text-xs mb-4 font-medium"></div>
            <div class="flex gap-3 justify-center">
                <button id="restart-btn" class="btn-secondary px-6 py-3 rounded-xl font-bold text-sm transition flex items-center gap-2">
                    <i class="fas fa-redo text-xs text-slate-400"></i> Ulang (<span id="btn-trials-left">1</span>)
                </button>
                <button id="show-rank-btn" class="btn-primary px-6 py-3 rounded-xl font-bold text-sm transition shadow-lg shadow-brand-500/20">
                    Lihat Ranking
                </button>
            </div>
        </div>
    </div>

    <!-- Leaderboard Modal (Public) -->
    <div id="leaderboard-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-white/80 backdrop-blur-md p-6 animate-[fadeIn_0.2s_ease-out]">
        <div class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden border border-slate-200">
            <div class="p-6 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-2xl text-slate-800 font-sans flex items-center gap-2">
                        <i class="fas fa-trophy text-brand-500"></i> Peringkat Kelas 8
                    </h3>
                    <p class="text-sm text-slate-500 mt-1">Data diurutkan berdasarkan WPM (Kecepatan) tertinggi.</p>
                </div>
                <button id="close-leaderboard" class="w-8 h-8 rounded-full bg-white hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-slate-600 transition border border-slate-200 shadow-sm">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4 bg-white border-b border-slate-200 flex justify-between items-center">
                 <div class="flex gap-2">
                    <span class="px-3 py-1 rounded-full bg-brand-50 text-brand-600 text-xs font-bold border border-brand-100">Top Speed</span>
                 </div>
            </div>
            <div class="p-0 overflow-y-auto flex-grow" id="leaderboard-list"></div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-md">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-200 relative">
            <button id="close-admin-login" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-user-shield text-slate-600 text-xl"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800">Login Admin</h3>
                <p class="text-xs text-slate-500">Masukkan password untuk akses data.</p>
            </div>
            <input type="password" id="admin-password" class="clean-input w-full rounded-lg px-4 py-3 text-sm mb-2" placeholder="Password Admin...">
            <!-- Pesan Error -->
            <p id="admin-login-error" class="hidden text-red-500 text-xs font-bold mb-3 text-center bg-red-50 py-2 rounded border border-red-100"><i class="fas fa-exclamation-circle mr-1"></i> Password Salah!</p>
            
            <button id="admin-submit-btn" class="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 rounded-lg transition text-sm">
                Masuk Dashboard
            </button>
        </div>
    </div>

    <!-- Admin Dashboard Modal -->
    <div id="admin-dashboard-modal" class="hidden fixed inset-0 z-[100] bg-slate-900 overflow-y-auto">
        <!-- Background Effect for E-Sports vibe -->
        <div class="fixed inset-0 pointer-events-none opacity-20 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-blue-700 via-slate-900 to-black"></div>
        
        <div class="relative w-full min-h-screen flex flex-col">
            <!-- Header Admin -->
            <div class="flex justify-between items-center py-4 px-6 border-b border-slate-700/50 sticky top-0 bg-slate-900/90 backdrop-blur-md z-20 shadow-xl">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-gradient-to-br from-brand-500 to-blue-600 rounded-lg shadow flex items-center justify-center">
                        <i class="fas fa-database text-white text-lg"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-display text-white tracking-wide">ADMIN DASHBOARD</h2>
                        <p class="text-slate-400 text-xs font-mono">LIVE CONTROL CENTER</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="admin-reset-global-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition shadow-lg shadow-red-500/20" title="Reset semua komputer">
                        <i class="fas fa-broadcast-tower"></i> Reset ALL
                    </button>
                    <button id="admin-download-btn" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition shadow-lg shadow-emerald-500/20">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                    <button id="close-admin-dashboard" class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-sm transition border border-slate-700">
                        Keluar
                    </button>
                </div>
            </div>
            
            <!-- Dashboard Content -->
            <div class="flex flex-col lg:flex-row h-full flex-grow">
                <!-- Left: Stats & Podium -->
                <div class="flex-grow p-6 overflow-y-auto">
                    <!-- Podium Section (Moved here) -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 items-end justify-center px-4 md:px-10 max-w-5xl mx-auto" id="podium-container">
                        <!-- Podium 2 (Silver) -->
                        <div class="order-2 md:order-1 flex flex-col items-center">
                            <div class="w-full bg-slate-800/50 rounded-2xl p-4 border border-slate-700 backdrop-blur-sm relative overflow-hidden podium-card">
                                <div class="absolute top-0 left-0 w-full h-1 silver-gradient"></div>
                                <div class="text-center">
                                    <div class="w-16 h-16 rounded-full silver-gradient mx-auto mb-3 flex items-center justify-center shadow-lg text-slate-800 font-bold text-2xl">2</div>
                                    <h3 class="text-white font-bold text-lg truncate" id="p2-name">-</h3>
                                    <p class="text-slate-400 text-xs mb-2" id="p2-class">-</p>
                                    <div class="text-3xl font-mono font-bold text-slate-200" id="p2-wpm">0</div>
                                    <span class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">WPM</span>
                                    <div class="mt-2 flex justify-center gap-3 text-[10px] text-slate-400">
                                        <span><i class="fas fa-clock"></i> <span id="p2-time">0s</span></span>
                                        <span><i class="fas fa-bullseye"></i> <span id="p2-acc">0%</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Podium 1 (Gold) -->
                        <div class="order-1 md:order-2 flex flex-col items-center z-10 transform md:-translate-y-4">
                            <div class="w-full bg-slate-800/80 rounded-2xl p-6 border border-yellow-500/30 backdrop-blur-md relative overflow-hidden shadow-[0_0_30px_rgba(234,179,8,0.2)] podium-card">
                                <div class="absolute top-0 left-0 w-full h-1.5 gold-gradient"></div>
                                <div class="text-center relative">
                                    <i class="fas fa-crown text-yellow-400 text-2xl absolute -top-8 left-1/2 -translate-x-1/2 animate-bounce"></i>
                                    <div class="w-20 h-20 rounded-full gold-gradient mx-auto mb-4 flex items-center justify-center shadow-xl text-yellow-900 font-bold text-3xl">1</div>
                                    <h3 class="text-white font-bold text-xl truncate" id="p1-name">-</h3>
                                    <p class="text-yellow-100/50 text-xs mb-3" id="p1-class">-</p>
                                    <div class="text-5xl font-mono font-bold text-yellow-400" id="p1-wpm">0</div>
                                    <span class="text-[10px] text-yellow-500 uppercase font-bold tracking-widest">WPM SCORE</span>
                                    <div class="mt-2 flex justify-center gap-3 text-xs text-yellow-200/60 font-mono">
                                        <span><i class="fas fa-clock"></i> <span id="p1-time">0s</span></span>
                                        <span><i class="fas fa-bullseye"></i> <span id="p1-acc">0%</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Podium 3 (Bronze) -->
                        <div class="order-3 md:order-3 flex flex-col items-center">
                            <div class="w-full bg-slate-800/50 rounded-2xl p-4 border border-slate-700 backdrop-blur-sm relative overflow-hidden podium-card">
                                <div class="absolute top-0 left-0 w-full h-1 bronze-gradient"></div>
                                <div class="text-center">
                                    <div class="w-16 h-16 rounded-full bronze-gradient mx-auto mb-3 flex items-center justify-center shadow-lg text-white font-bold text-2xl">3</div>
                                    <h3 class="text-white font-bold text-lg truncate" id="p3-name">-</h3>
                                    <p class="text-slate-400 text-xs mb-2" id="p3-class">-</p>
                                    <div class="text-3xl font-mono font-bold text-orange-200" id="p3-wpm">0</div>
                                    <span class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">WPM</span>
                                    <div class="mt-2 flex justify-center gap-3 text-[10px] text-slate-400">
                                        <span><i class="fas fa-clock"></i> <span id="p3-time">0s</span></span>
                                        <span><i class="fas fa-bullseye"></i> <span id="p3-acc">0%</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- NEW: Live Chart Section -->
                    <div class="mb-8 bg-slate-800/40 rounded-2xl border border-slate-700 p-4">
                        <h4 class="font-bold text-slate-400 mb-4 text-sm uppercase tracking-wider flex items-center gap-2">
                            <i class="fas fa-chart-bar text-brand-500"></i> Grafik Posisi Realtime (Top 10)
                        </h4>
                        <div class="relative h-64 w-full">
                            <canvas id="liveChart"></canvas>
                        </div>
                    </div>

                    <!-- Live Data Table -->
                    <div class="bg-slate-800/40 rounded-2xl border border-slate-700 overflow-hidden backdrop-blur-sm">
                        <h4 class="p-4 font-bold text-slate-400 text-sm uppercase tracking-wider bg-slate-800/50 border-b border-slate-700">
                            <i class="fas fa-list"></i> Data Nilai Masuk
                        </h4>
                        <table class="w-full text-left text-slate-300">
                            <thead class="bg-slate-800/80 text-xs uppercase text-slate-400">
                                <tr>
                                    <th class="px-6 py-4 font-bold tracking-wider">#</th>
                                    <th class="px-6 py-4 font-bold tracking-wider">Siswa</th>
                                    <th class="px-6 py-4 font-bold tracking-wider">Kelas</th>
                                    <th class="px-6 py-4 font-bold tracking-wider">Waktu</th>
                                    <th class="px-6 py-4 text-right font-bold tracking-wider">WPM</th>
                                    <th class="px-6 py-4 text-right font-bold tracking-wider">Akurasi</th>
                                </tr>
                            </thead>
                            <tbody id="live-list-body" class="divide-y divide-slate-700/50">
                                <!-- Rows injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Right Sidebar: Online Computers -->
                <div class="w-full lg:w-80 p-4 bg-slate-800/30 border-l border-slate-700 overflow-y-auto">
                    <h4 class="font-bold text-slate-400 mb-3 flex items-center gap-2 text-sm uppercase">
                        <i class="fas fa-network-wired text-green-500"></i> Komputer Online <span id="online-count" class="bg-green-900/50 text-green-400 text-xs px-2 py-0.5 rounded-full border border-green-800">0</span>
                    </h4>
                    <p class="text-[10px] text-slate-500 mb-4">Monitor status koneksi dan reset sesi siswa.</p>
                    
                    <div id="online-computers-list" class="space-y-2">
                        <div class="text-center text-slate-500 text-xs py-4 italic">Menunggu koneksi...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="clean-panel border-t border-slate-200 p-4 relative z-10 bg-white/90 flex flex-col lg:flex-row justify-between items-center gap-4">
        <!-- Keyboard (Desktop Only) -->
        <div class="hidden lg:block flex-1">
            <div class="flex justify-center transform scale-90 origin-bottom">
                <div class="keyboard-base">
                    <div class="key-row"><div class="key" data-code="Backquote">`</div><div class="key" data-code="Digit1">1</div><div class="key" data-code="Digit2">2</div><div class="key" data-code="Digit3">3</div><div class="key" data-code="Digit4">4</div><div class="key" data-code="Digit5">5</div><div class="key" data-code="Digit6">6</div><div class="key" data-code="Digit7">7</div><div class="key" data-code="Digit8">8</div><div class="key" data-code="Digit9">9</div><div class="key" data-code="Digit0">0</div><div class="key" data-code="Minus">-</div><div class="key" data-code="Equal">=</div><div class="key w-backspace text-xs" data-code="Backspace"><i class="fas fa-backspace"></i></div></div>
                    <div class="key-row"><div class="key w-tab text-[10px]" data-code="Tab">TAB</div><div class="key" data-code="KeyQ">Q</div><div class="key" data-code="KeyW">W</div><div class="key" data-code="KeyE">E</div><div class="key" data-code="KeyR">R</div><div class="key" data-code="KeyT">T</div><div class="key" data-code="KeyY">Y</div><div class="key" data-code="KeyU">U</div><div class="key" data-code="KeyI">I</div><div class="key" data-code="KeyO">O</div><div class="key" data-code="KeyP">P</div><div class="key" data-code="BracketLeft">[</div><div class="key" data-code="BracketRight">]</div><div class="key w-auto" data-code="Backslash">\</div></div>
                    <div class="key-row"><div class="key w-caps text-[10px]" data-code="CapsLock">CAPS</div><div class="key" data-code="KeyA">A</div><div class="key" data-code="KeyS">S</div><div class="key" data-code="KeyD">D</div><div class="key" data-code="KeyF">F</div><div class="key" data-code="KeyG">G</div><div class="key" data-code="KeyH">H</div><div class="key" data-code="KeyJ">J</div><div class="key" data-code="KeyK">K</div><div class="key" data-code="KeyL">L</div><div class="key" data-code="Semicolon">;</div><div class="key" data-code="Quote">'</div><div class="key w-enter text-[10px]" data-code="Enter">ENTER</div></div>
                    <div class="key-row"><div class="key w-shift text-[10px]" data-code="ShiftLeft">SHIFT</div><div class="key" data-code="KeyZ">Z</div><div class="key" data-code="KeyX">X</div><div class="key" data-code="KeyC">C</div><div class="key" data-code="KeyV">V</div><div class="key" data-code="KeyB">B</div><div class="key" data-code="KeyN">N</div><div class="key" data-code="KeyM">M</div><div class="key" data-code="Comma">,</div><div class="key" data-code="Period">.</div><div class="key" data-code="Slash">/</div><div class="key w-shift text-[10px]" data-code="ShiftRight">SHIFT</div></div>
                    <div class="key-row"><div class="key w-space" data-code="Space"></div></div>
                </div>
            </div>
        </div>
        
        <!-- Admin Button (Footer) - Optional, keep for redundancy -->
        <button id="open-admin-btn" class="absolute bottom-4 right-4 bg-slate-200 hover:bg-slate-300 text-slate-600 px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-2">
            <i class="fas fa-lock"></i> Admin
        </button>
    </footer>

    <script>
        // --- GEMINI AI FUNCTIONS ---
        const defaultParagraphs = [
            "Teknologi informasi dan komunikasi telah berkembang sangat pesat dalam dua dekade terakhir, mengubah cara manusia bekerja, belajar, dan berinteraksi satu sama lain. Di era digital ini, literasi komputer bukan lagi sekadar keterampilan tambahan, melainkan kebutuhan mendasar bagi setiap individu yang ingin bersaing di dunia global. Siswa sekolah menengah pertama diharapkan tidak hanya mampu menggunakan aplikasi perkantoran standar, tetapi juga memahami etika digital, keamanan siber, dan logika pemrograman dasar untuk memecahkan masalah sehari-hari.",
            "Sumpah Pemuda pada tanggal 28 Oktober 1928 merupakan tonggak sejarah penting dalam pergerakan kemerdekaan Indonesia. Ikrar ini menegaskan cita-cita berdirinya negara Indonesia dengan semangat satu tanah air, satu bangsa, dan satu bahasa. Peristiwa ini mengajarkan kita bahwa persatuan dan kesatuan adalah kunci utama dalam menghadapi segala tantangan bangsa. Sebagai generasi penerus, pelajar memiliki tanggung jawab moral untuk menjaga keutuhan Negara Kesatuan Republik Indonesia dengan cara belajar tekun dan berprestasi.",
            "Pemanasan global adalah isu lingkungan mendesak yang membutuhkan perhatian serius dari seluruh penduduk bumi. Meningkatnya suhu rata-rata atmosfer, laut, dan daratan bumi telah menyebabkan perubahan pola cuaca yang ekstrem dan naiknya permukaan air laut. Upaya penanggulangan seperti reboisasi hutan, pengurangan emisi gas rumah kaca, dan penggunaan energi terbarukan harus terus digalakkan. Generasi muda dapat berkontribusi mulai dari hal kecil, seperti mengurangi penggunaan plastik sekali pakai dan menghemat penggunaan listrik di rumah.",
            "Pendidikan karakter di sekolah bertujuan untuk membentuk pribadi siswa yang tidak hanya cerdas secara intelektual, tetapi juga memiliki moral yang baik dan integritas tinggi. Nilai-nilai seperti kejujuran, disiplin, tanggung jawab, dan gotong royong harus ditanamkan sejak dini agar menjadi kebiasaan yang melekat. Dalam menghadapi revolusi industri 4.0, kecerdasan emosional dan kemampuan beradaptasi menjadi faktor penentu kesuksesan seseorang, melengkapi kemampuan teknis yang diperoleh di bangku sekolah."
        ];

        async function getAIParagraph() {
            if (!geminiApiKey) return defaultParagraphs[Math.floor(Math.random() * defaultParagraphs.length)];
            
            // Updated prompt for longer text
            const prompt = "Buatkan 1 paragraf panjang (sekitar 100-150 kata) dalam bahasa Indonesia baku yang edukatif untuk siswa SMP kelas 8. Topik: Teknologi AI, Sejarah Majapahit, atau Biologi Lingkungan. Langsung berikan paragrafnya saja tanpa pembuka/penutup.";
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                return text || defaultParagraphs[Math.floor(Math.random() * defaultParagraphs.length)];
            } catch (e) {
                console.error("Gemini Error:", e);
                return defaultParagraphs[Math.floor(Math.random() * defaultParagraphs.length)];
            }
        }

        async function getAIFeedback(wpm, acc) {
            if (!geminiApiKey) return "Tingkatkan terus kecepatan dan ketepatan mengetik Anda!";
            
            const prompt = `Berikan komentar motivasi singkat (maksimal 1 kalimat pendek) untuk siswa SMP yang baru saja ujian mengetik dengan hasil: Kecepatan ${wpm} WPM dan Akurasi ${acc}%. Jika nilai bagus puji, jika kurang beri semangat. Gunakan bahasa Indonesia santai namun sopan.`;
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "Kerja bagus, terus berlatih!";
            } catch (e) {
                return "Tetap semangat dan terus berlatih!";
            }
        }

        // --- KONFIGURASI SUPABASE & GEMINI ---
        const supabaseUrl = 'https://bpqyuaotsxujsqsxxdlu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwcXl1YW90c3h1anNxc3h4ZGx1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTgwMTYsImV4cCI6MjA4NjEzNDAxNn0.JzqIzLN-O7B0CVVLjtft4LLlF4k15ulmo3mPYMexvHw';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey); 

        const geminiApiKey = ""; 

        let allResultsData = []; 
        let examChannel = null;
        let chartInstance = null; // Store chart instance

        // --- IDENTITY MANAGEMENT ---
        const myClientId = localStorage.getItem('typing_exam_client_id') || crypto.randomUUID().substring(0, 8);
        localStorage.setItem('typing_exam_client_id', myClientId);
        
        const displayIdEl = document.getElementById('display-client-id');
        if(displayIdEl) displayIdEl.innerText = myClientId;

        // --- Check Connection ---
        async function checkConnection() {
            const dot = document.getElementById('db-dot');
            const text = document.getElementById('db-text');
            try {
                const { count, error } = await supabaseClient.from('exam_results').select('*', { count: 'exact', head: true });
                if (!error) {
                    dot.className = 'status-dot status-online';
                    text.innerText = "ONLINE";
                    text.className = "text-[10px] font-bold text-green-600 uppercase tracking-wider";
                } else { throw error; }
            } catch (e) {
                dot.className = 'status-dot status-offline';
                text.innerText = "OFFLINE";
                text.className = "text-[10px] font-bold text-red-600 uppercase tracking-wider";
                console.error("Connection failed:", e);
            }
        }
        checkConnection();

        // --- SETUP REALTIME ---
        function setupRealtime() {
            // Channel 1: Presence & Commands
            examChannel = supabaseClient.channel('exam_room_global_v2');
            
            examChannel
                .on('broadcast', { event: 'cmd_reset' }, ({ payload }) => {
                    if (payload.target === 'ALL' || payload.target === myClientId) performLocalReset(true); 
                })
                .on('presence', { event: 'sync' }, () => {
                    const newState = examChannel.presenceState();
                    renderOnlineComputers(newState);
                })
                .subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        updatePresence();
                    }
                });

            // Channel 2: DB Changes for Live Scoreboard
            const dbChannel = supabaseClient.channel('public:exam_results');
            dbChannel
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'exam_results' }, payload => {
                    console.log('New Score!', payload.new);
                    const newEntry = { ...payload.new, date: new Date(payload.new.created_at).toLocaleString('id-ID') };
                    allResultsData.push(newEntry);
                    allResultsData.sort((a,b) => b.wpm !== a.wpm ? b.wpm - a.wpm : b.accuracy - a.accuracy);
                    
                    // Update all admin views
                    renderLivePodium(allResultsData);
                    updateLiveChart(allResultsData);
                })
                .subscribe();
        }
        setupRealtime();

        async function updatePresence() {
            if (!examChannel || !myClientId) return;
            const isLocked = state.trialsUsed >= MAX_TRIALS;
            const statusText = isLocked ? 'TERKUNCI' : 'SIAP';
            await examChannel.track({
                id: myClientId,
                name: localStorage.getItem('typing_last_name') || 'Siswa (' + myClientId + ')',
                status: statusText, 
                online_at: new Date().toISOString()
            });
        }

        // --- CHART.JS SETUP ---
        function initChart() {
            const ctx = document.getElementById('liveChart').getContext('2d');
            
            // Gradient fill
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.8)'); // Brand color
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0.1)');

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Kecepatan (WPM)',
                        data: [],
                        backgroundColor: gradient,
                        borderColor: '#3b82f6',
                        borderWidth: 1,
                        borderRadius: 4,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal Bar Chart for racing effect
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#e2e8f0', font: { weight: 'bold' } }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        function updateLiveChart(data) {
            if (!chartInstance) return;
            
            // Take top 10
            const top10 = data.slice(0, 10);
            
            chartInstance.data.labels = top10.map(d => d.nama);
            chartInstance.data.datasets[0].data = top10.map(d => d.wpm);
            chartInstance.update();
        }

        // --- RENDER FUNCTIONS ---
        function renderOnlineComputers(presenceState) {
            const listEl = document.getElementById('online-computers-list');
            const countEl = document.getElementById('online-count');
            const users = [];
            for (const key in presenceState) users.push(...presenceState[key]);
            
            if(countEl) countEl.innerText = users.length;
            if (!listEl) return;
            
            if (users.length === 0) {
                listEl.innerHTML = '<div class="text-center text-slate-500 text-xs py-4 italic">Tidak ada komputer online.</div>';
                return;
            }

            let html = '';
            users.forEach(user => {
                const isMe = user.id === myClientId ? '(Ini)' : '';
                const statusColor = user.status === 'TERKUNCI' ? 'text-red-400 bg-red-900/30 border-red-800' : 'text-green-400 bg-green-900/30 border-green-800';
                const statusDot = user.status === 'TERKUNCI' ? 'bg-red-500' : 'bg-green-500';
                
                html += `
                <div class="flex items-center justify-between bg-slate-700/30 p-2 rounded border border-slate-600 mb-2">
                    <div class="flex items-center gap-2 overflow-hidden flex-grow">
                        <div class="w-2 h-2 ${statusDot} rounded-full animate-pulse flex-shrink-0"></div>
                        <div class="flex flex-col truncate min-w-0">
                            <span class="text-xs font-bold text-slate-300 truncate" title="${user.name}">${user.name}</span>
                            <div class="flex gap-2 items-center">
                                <span class="text-[10px] text-slate-500 font-mono">ID: ${user.id} ${isMe}</span>
                                <span class="text-[9px] px-1.5 py-0.5 rounded border ${statusColor} font-bold">${user.status || 'SIAP'}</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="sendResetCommand('${user.id}', this)" class="ml-2 bg-slate-700 hover:bg-orange-900/50 text-orange-400 border border-slate-600 hover:border-orange-500/50 px-3 py-1.5 rounded text-[10px] font-bold transition shadow-sm whitespace-nowrap">Reset</button>
                </div>`;
            });
            listEl.innerHTML = html;
        }

        window.sendResetCommand = async (targetId, btnElement) => {
            if(!confirm(`Reset akses ujian untuk Komputer ID: ${targetId}?`)) return;
            if (targetId === myClientId) { performLocalReset(true); return; }
            const originalText = btnElement.innerText;
            btnElement.innerText = "...";
            btnElement.disabled = true;
            try {
                await examChannel.send({ type: 'broadcast', event: 'cmd_reset', payload: { target: targetId } });
                btnElement.innerText = "OK";
                setTimeout(() => {
                    btnElement.innerText = originalText;
                    btnElement.disabled = false;
                }, 1000);
            } catch (e) {
                console.error("Reset Error:", e);
                btnElement.innerText = originalText;
                btnElement.disabled = false;
            }
        };

        function performLocalReset(isRemote = false) {
            localStorage.removeItem('typing_exam_trials_used');
            state.trialsUsed = 0;
            updateTrialUI();
            const startBtn = document.getElementById('start-btn');
            const limitWarning = document.getElementById('limit-warning');
            const restartBtn = document.getElementById('restart-btn');
            if(startBtn) { startBtn.disabled = false; startBtn.innerHTML = '<span>Mulai Ujian</span> <i class="fas fa-arrow-right"></i>'; }
            if(limitWarning) limitWarning.classList.add('hidden');
            if(restartBtn) { restartBtn.disabled = false; restartBtn.classList.remove('opacity-50', 'cursor-not-allowed'); }
            updatePresence();
            if (isRemote) {
                showToast("Admin telah me-reset akses ujian Anda. Silakan mulai.");
                if (state.nama) localStorage.setItem('typing_last_name', state.nama);
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            const msg = document.getElementById('toast-message');
            msg.innerText = message;
            toast.classList.remove('translate-x-full', 'opacity-0');
            setTimeout(() => { toast.classList.add('translate-x-full', 'opacity-0'); }, 4000);
        }

        // --- GAME LOGIC ---
        const MAX_TRIALS = 2;
        let state = { active: false, finished: false, startTime: 0, elapsedTime: 0, fullText: "", words: [], charElements: [], currentIndex: 0, correctChars: 0, incorrectChars: 0, timerInterval: null, nama: "", kelas: "", absen: "", trialsUsed: 0 };

        const typingArea = document.getElementById('typing-area');
        const timerEl = document.getElementById('timer');
        const wpmEl = document.getElementById('wpm-live');
        const accEl = document.getElementById('accuracy-live');
        const startOverlay = document.getElementById('start-overlay');
        const resultOverlay = document.getElementById('result-overlay');
        const liveStats = document.getElementById('live-stats');
        const loadingOverlay = document.getElementById('loading-overlay');
        const aiFeedbackEl = document.getElementById('ai-feedback');
        
        const inpNama = document.getElementById('input-nama');
        const inpKelas = document.getElementById('input-kelas');
        const inpAbsen = document.getElementById('input-absen');
        const startBtn = document.getElementById('start-btn');
        const trialsDisplay = document.getElementById('trials-display');
        const limitWarning = document.getElementById('limit-warning');
        const restartBtn = document.getElementById('restart-btn');
        const startAdminBtn = document.getElementById('start-admin-btn'); 

        function initTrials() {
            const savedTrials = localStorage.getItem('typing_exam_trials_used');
            if (savedTrials) state.trialsUsed = parseInt(savedTrials);
            updateTrialUI();
            updatePresence(); 
        }
        
        function updateTrialUI() {
            const left = MAX_TRIALS - state.trialsUsed;
            trialsDisplay.innerText = `${state.trialsUsed} / ${MAX_TRIALS}`;
            document.getElementById('btn-trials-left').innerText = left > 0 ? left : 0;
            if (state.trialsUsed >= MAX_TRIALS) {
                startBtn.disabled = true;
                startBtn.innerHTML = '<i class="fas fa-lock mr-2"></i> KESEMPATAN HABIS';
                limitWarning.classList.remove('hidden');
                inpNama.disabled = true; inpKelas.disabled = true; inpAbsen.disabled = true;
                restartBtn.disabled = true; restartBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                startBtn.disabled = false;
                startBtn.innerHTML = '<span>Mulai Ujian</span> <i class="fas fa-arrow-right"></i>';
                limitWarning.classList.add('hidden');
                inpNama.disabled = false; inpKelas.disabled = false; inpAbsen.disabled = false;
                restartBtn.disabled = false; restartBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        startAdminBtn.addEventListener('click', () => { adminLoginModal.classList.remove('hidden'); });
        initTrials();
        loadLeaderboard(); 

        startBtn.addEventListener('click', prepareGame);
        restartBtn.addEventListener('click', resetGame);
        document.getElementById('quick-restart').addEventListener('click', resetGame);
        document.getElementById('focus-error').addEventListener('click', () => document.getElementById('focus-error').classList.add('hidden'));

        window.addEventListener('keydown', (e) => {
            // DETEKSI FORM INPUT (Nama/Login) - AGAR BISA SPASI
            const isFormInput = e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA';

            const keyEl = document.querySelector(`.key[data-code="${e.code}"]`);
            if(keyEl) keyEl.classList.add('pressed');
            
            if (e.key === "Tab") { e.preventDefault(); return; }
            
            // Prevent Scroll HANYA jika BUKAN di form input
            if (e.key === " " && !isFormInput) e.preventDefault();

            // Jika sedang mengetik di input, JANGAN jalankan game logic
            if (isFormInput) return;

            // Logic Game
            const adminModal = document.getElementById('admin-login-modal');
            const dashboardModal = document.getElementById('admin-dashboard-modal');
            if (!state.active && !state.finished && startOverlay.classList.contains('hidden') && 
                adminModal.classList.contains('hidden') && dashboardModal.classList.contains('hidden')) {
                 if (e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey) startTimer();
            }
            if (state.active && !state.finished) {
                if (e.key === "Backspace") handleBackspace();
                else if (e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey) handleInput(e.key);
            }
        });

        window.addEventListener('keyup', (e) => {
            const keyEl = document.querySelector(`.key[data-code="${e.code}"]`);
            if(keyEl) keyEl.classList.remove('pressed');
        });

        async function prepareGame() {
            if (state.trialsUsed >= MAX_TRIALS) return;
            const nama = inpNama.value.trim(); const kelas = inpKelas.value; const absen = inpAbsen.value.trim();
            if (!nama || !kelas || !absen) { alert("Harap isi Nama, Kelas, dan No. Absen dengan lengkap!"); return; }
            state.nama = nama; state.kelas = kelas; state.absen = absen;
            localStorage.setItem('typing_last_name', nama);
            if(examChannel) { await examChannel.track({ id: myClientId, name: nama, status: 'SEDANG UJIAN', online_at: new Date().toISOString() }); }
            loadingOverlay.classList.remove('hidden');
            const text = await getAIParagraph();
            state.fullText = text.split("");
            loadingOverlay.classList.add('hidden');
            typingArea.innerHTML = ''; state.charElements = [];
            state.fullText.forEach(char => {
                const span = document.createElement('span'); span.innerText = char; span.className = 'letter pending';
                typingArea.appendChild(span); state.charElements.push(span);
            });
            state.currentIndex = 0; state.correctChars = 0; state.incorrectChars = 0;
            state.elapsedTime = 0; state.active = false; state.finished = false;
            timerEl.innerText = '0'; wpmEl.innerText = '0'; accEl.innerText = '100%';
            state.charElements[0].classList.add('active');
            startOverlay.classList.add('hidden'); resultOverlay.classList.add('hidden');
            liveStats.classList.remove('hidden');
        }

        function startTimer() {
            state.active = true;
            state.startTime = Date.now();
            state.timerInterval = setInterval(() => {
                state.elapsedTime = Math.floor((Date.now() - state.startTime) / 1000);
                timerEl.innerText = state.elapsedTime;
                const minutes = state.elapsedTime / 60;
                if (minutes > 0) {
                    const wpm = Math.round((state.correctChars / 5) / minutes);
                    wpmEl.innerText = wpm;
                }
            }, 1000);
        }

        function handleInput(key) {
            const currentEl = state.charElements[state.currentIndex];
            const correctChar = state.fullText[state.currentIndex];
            currentEl.classList.remove('active');
            if (key === correctChar) { currentEl.className = 'letter correct'; state.correctChars++; } 
            else { currentEl.className = 'letter incorrect'; state.incorrectChars++; }
            state.currentIndex++;
            if (state.currentIndex >= state.fullText.length) endGame();
            else state.charElements[state.currentIndex].classList.add('active');
            const total = state.correctChars + state.incorrectChars;
            accEl.innerText = Math.round((state.correctChars / total) * 100) + "%";
        }

        function handleBackspace() {
            if (state.currentIndex > 0) {
                if (state.currentIndex < state.fullText.length) state.charElements[state.currentIndex].classList.remove('active');
                state.currentIndex--;
                const prevEl = state.charElements[state.currentIndex];
                if (prevEl.classList.contains('correct')) state.correctChars--;
                if (prevEl.classList.contains('incorrect')) state.incorrectChars--;
                prevEl.className = 'letter pending active';
            }
        }

        async function endGame() {
            clearInterval(state.timerInterval); state.active = false; state.finished = true;
            state.trialsUsed++; localStorage.setItem('typing_exam_trials_used', state.trialsUsed); updateTrialUI();
            updatePresence();
            const minutes = state.elapsedTime / 60;
            const grossWPM = minutes > 0 ? Math.round((state.correctChars / 5) / minutes) : 0; 
            const accuracy = state.correctChars + state.incorrectChars === 0 ? 0 : Math.round((state.correctChars / (state.correctChars + state.incorrectChars)) * 100);
            document.getElementById('final-wpm').innerText = grossWPM;
            document.getElementById('final-acc').innerText = accuracy + "%";
            aiFeedbackEl.innerText = "Sedang meminta komentar guru AI...";
            resultOverlay.classList.remove('hidden');
            const feedback = await getAIFeedback(grossWPM, accuracy);
            aiFeedbackEl.innerText = `"${feedback}"`;
            saveResult(grossWPM, accuracy);
        }

        function resetGame() {
            clearInterval(state.timerInterval); state.active = false;
            updatePresence(); 
            if (state.trialsUsed >= MAX_TRIALS) {
                startOverlay.classList.remove('hidden'); resultOverlay.classList.add('hidden');
                liveStats.classList.add('hidden'); typingArea.innerHTML = ''; return;
            }
            startOverlay.classList.remove('hidden'); resultOverlay.classList.add('hidden');
            liveStats.classList.add('hidden'); typingArea.innerHTML = '';
        }

        // --- SAVE & RENDER (MODIFIED) ---
        async function saveResult(wpm, acc) {
            const msg = document.getElementById('save-msg');
            msg.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Menyimpan nilai...';
            msg.className = "h-6 text-xs mb-6 font-medium text-brand-500";
            const { error } = await supabaseClient.from('exam_results').insert({
                nama: state.nama, kelas: state.kelas, absen: state.absen,
                wpm: wpm, accuracy: acc, trial_no: state.trialsUsed,
                // duration: state.elapsedTime // DISABLED: Database column missing
            });
            if (error) {
                console.error("Error:", error);
                msg.innerText = "Gagal menyimpan online. Cek koneksi.";
                msg.className = "h-6 text-xs mb-6 font-medium text-red-500";
            } else {
                msg.innerHTML = '<i class="fas fa-check-circle"></i> Nilai berhasil disimpan!';
                msg.className = "h-6 text-xs mb-6 font-medium text-emerald-600";
                loadLeaderboard();
            }
        }

        async function loadLeaderboard() {
            const { data, error } = await supabaseClient.from('exam_results').select('*').order('wpm', { ascending: false });
            if (error) { console.error("Error loading:", error); return; }
            allResultsData = data.map(d => ({ ...d, date: new Date(d.created_at).toLocaleString('id-ID') }));
            allResultsData.sort((a,b) => b.wpm !== a.wpm ? b.wpm - a.wpm : b.accuracy - a.accuracy);
            renderLivePodium(allResultsData);
            updateLiveChart(allResultsData);
        }

        function renderLivePodium(data) {
            const p1 = data[0] || { nama: '-', kelas: '-', wpm: 0, duration: 0, accuracy: 0 };
            const p2 = data[1] || { nama: '-', kelas: '-', wpm: 0, duration: 0, accuracy: 0 };
            const p3 = data[2] || { nama: '-', kelas: '-', wpm: 0, duration: 0, accuracy: 0 };

            document.getElementById('p1-name').innerText = p1.nama;
            document.getElementById('p1-class').innerText = p1.kelas;
            document.getElementById('p1-wpm').innerText = p1.wpm;
            document.getElementById('p1-time').innerText = (p1.duration || 0) + 's';
            document.getElementById('p1-acc').innerText = p1.accuracy + '%';

            document.getElementById('p2-name').innerText = p2.nama;
            document.getElementById('p2-class').innerText = p2.kelas;
            document.getElementById('p2-wpm').innerText = p2.wpm;
            document.getElementById('p2-time').innerText = (p2.duration || 0) + 's';
            document.getElementById('p2-acc').innerText = p2.accuracy + '%';

            document.getElementById('p3-name').innerText = p3.nama;
            document.getElementById('p3-class').innerText = p3.kelas;
            document.getElementById('p3-wpm').innerText = p3.wpm;
            document.getElementById('p3-time').innerText = (p3.duration || 0) + 's';
            document.getElementById('p3-acc').innerText = p3.accuracy + '%';

            // List Body
            const listBody = document.getElementById('live-list-body');
            let html = '';
            const displayData = data.slice(3, 20); 
            if(displayData.length === 0 && data.length <= 3) {
                html = '<tr><td colspan="6" class="px-6 py-8 text-center text-slate-500 italic">Belum ada peserta lain.</td></tr>';
            } else {
                displayData.forEach((r, i) => {
                    const rank = i + 4;
                    html += `<tr class="hover:bg-slate-700/30 transition border-b border-slate-700/50"><td class="px-6 py-3 font-mono text-slate-400">#${rank}</td><td class="px-6 py-3 font-bold text-white">${r.nama}</td><td class="px-6 py-3 text-slate-400 font-mono text-xs">${r.kelas}</td><td class="px-6 py-3 font-mono text-slate-300 font-bold">${r.duration ? r.duration + 's' : '-'}</td><td class="px-6 py-3 text-right font-mono font-bold text-brand-400 text-lg">${r.wpm}</td><td class="px-6 py-3 text-right font-mono text-emerald-400">${r.accuracy}%</td></tr>`;
                });
            }
            listBody.innerHTML = html;
        }

        // --- Admin Handlers ---
        const openAdminBtn = document.getElementById('open-admin-btn');
        const adminLoginModal = document.getElementById('admin-login-modal');
        const closeAdminLogin = document.getElementById('close-admin-login');
        const adminSubmitBtn = document.getElementById('admin-submit-btn');
        const adminPassInput = document.getElementById('admin-password');
        const adminDashboard = document.getElementById('admin-dashboard-modal');
        const closeAdminDash = document.getElementById('close-admin-dashboard');
        const adminLoginError = document.getElementById('admin-login-error'); 
        const adminResetGlobalBtn = document.getElementById('admin-reset-global-btn');
        const adminDownloadBtn = document.getElementById('admin-download-btn');

        openAdminBtn.onclick = () => { adminLoginModal.classList.remove('hidden'); adminPassInput.value = ''; adminLoginError.classList.add('hidden'); adminPassInput.classList.remove('border-red-500'); };
        closeAdminLogin.onclick = () => adminLoginModal.classList.add('hidden');
        closeAdminDash.onclick = () => { adminDashboard.classList.add('hidden'); if (!state.active && !state.finished) startOverlay.classList.remove('hidden'); };
        
        adminPassInput.addEventListener('input', () => { adminLoginError.classList.add('hidden'); adminPassInput.classList.remove('border-red-500', 'animate-pulse'); });
        adminPassInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') adminSubmitBtn.click(); });

        adminSubmitBtn.onclick = () => {
            if(adminPassInput.value === 'admin123') {
                adminLoginModal.classList.add('hidden');
                startOverlay.classList.add('hidden'); 
                adminDashboard.classList.remove('hidden');
                loadLeaderboard(); 
                if(!chartInstance) initChart();
            } else {
                adminLoginError.classList.remove('hidden');
                adminPassInput.classList.add('border-red-500', 'animate-pulse');
            }
        };

        adminResetGlobalBtn.onclick = async () => {
            if(confirm("RESET GLOBAL: Reset semua?")) {
                await examChannel.send({ type: 'broadcast', event: 'cmd_reset', payload: { target: 'ALL' } });
            }
        };

        adminDownloadBtn.onclick = () => {
            if (allResultsData.length === 0) return alert("Data kosong");
            const ws = XLSX.utils.json_to_sheet(allResultsData.map((r,i) => ({ Ranking: i+1, Nama: r.nama, Kelas: r.kelas, Absen: r.absen, Waktu: r.duration, WPM: r.wpm, Akurasi: r.accuracy, Tanggal: r.date })));
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Hasil"); XLSX.writeFile(wb, "Hasil_Ujian.xlsx");
        };
    </script>
</body>
</html>
